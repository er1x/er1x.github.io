<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Hace poco me surgió la necesidad dentro de un proyecto de catalogar una gran cantidad de sitios web, y se me ocurrió crear un microservicio para ello. Cómo no, en Node.js.Es increíble la cantidad de p"><meta name="keywords" content="nodejs"><meta property="og:type" content="article"><meta property="og:title" content="Cómo crear un scraper escalable en menos de 100 líneas de JavaScript"><meta property="og:url" content="https://github.com/er1x/2015/06/crear-scraper-nodejs/index.html"><meta property="og:site_name" content="Emilio J. Grande | Web Developer"><meta property="og:description" content="Hace poco me surgió la necesidad dentro de un proyecto de catalogar una gran cantidad de sitios web, y se me ocurrió crear un microservicio para ello. Cómo no, en Node.js.Es increíble la cantidad de p"><meta property="og:locale" content="default"><meta property="og:image" content="https://github.com/images/2015-06/4440771174_c86df3788e_b.jpg"><meta property="og:updated_time" content="2017-03-11T12:54:27.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Cómo crear un scraper escalable en menos de 100 líneas de JavaScript"><meta name="twitter:description" content="Hace poco me surgió la necesidad dentro de un proyecto de catalogar una gran cantidad de sitios web, y se me ocurrió crear un microservicio para ello. Cómo no, en Node.js.Es increíble la cantidad de p"><meta name="twitter:image" content="https://github.com/images/2015-06/4440771174_c86df3788e_b.jpg"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>Cómo crear un scraper escalable en menos de 100 líneas de JavaScript</title></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" style="display:none"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives">Writing</a></li><li><a href="/projects">Projects</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li></ul></span><br><div id="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Diseno"><span class="toc-number">1.</span> <span class="toc-text">Diseño</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Servidor"><span class="toc-number">2.</span> <span class="toc-text">Servidor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Workers"><span class="toc-number">3.</span> <span class="toc-text">Workers</span></a></li></ol></div></span></div><div class="content index width mx-auto px2 my4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Cómo crear un scraper escalable en menos de 100 líneas de JavaScript</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Emilio J. Grande | Web Developer</span></span><div class="postdate">&nbsp;<time datetime="2015-06-15T05:22:00.000Z" itemprop="datePublished">15-06-2015</time></div><div class="article-tag"><i class="fa fa-tag"></i> <a class="tag-link" href="/tags/nodejs/">nodejs</a></div></div></header><div class="content" itemprop="articleBody"><p><img src="/images/2015-06/4440771174_c86df3788e_b.jpg" alt="nodejs scraping"></p><p>Hace poco me surgió la necesidad dentro de un proyecto de catalogar una gran cantidad de sitios web, y se me ocurrió crear un microservicio para ello. Cómo no, en Node.js.</p><p>Es increíble la cantidad de paquetes que tiene <a href="https://www.npmjs.com/" target="_blank" rel="external">NPM</a>, y cómo juntando estas pequeñas piezas de <em>Lego</em> puedes montar casi cualquier cosa.</p><h2 id="Diseno"><a href="#Diseno" class="headerlink" title="Diseño"></a>Diseño</h2><p>El objetivo que tenía este mini-proyecto era simple: <strong>extraer el contenido de un montón de sitios web (<em>scraping</em>) y guardarlo en una base de datos</strong>. Este texto posteriormente sería analizado por otro proceso, para clasificarlo en base a contenido, extraer información etc.</p><p>El sistema lo dividí en dos partes:</p><ul><li><strong>Un servidor web que expondría un API REST</strong>. Se encargaría de recibir listados de URLs a analizar mediante una petición POST.</li><li><strong>Una serie de <em>workers</em></strong>: procesos que recibirían las tareas de parte del servidor web, realizarían el scraping de contenido y guardarían el resultado en una base de datos, en este caso un MongoDB.</li></ul><p>La idea era poder utilizar varios servidores que ejecutara estos workers, de forma que el proceso de scraping fuera escalable.</p><h2 id="Servidor"><a href="#Servidor" class="headerlink" title="Servidor"></a>Servidor</h2><p>Para ayudarme a realizar el servidor que expondría la API escogí 3 bibliotecas:</p><ul><li><strong><a href="http://hapijs.com/" target="_blank" rel="external">Hapi</a></strong>: se trata de un <strong>framework para escribir servidores</strong>. Se diferencia de Express en que está más orientado a hacer las cosas por configuración, más que por código.</li><li><strong><a href="https://github.com/hapijs/joi">Joi</a></strong>: para realizar una mínima <strong>validación de los datos</strong> que entraban al servidor. Se integra estupendamente con Hapi y permite realizar validaciones complejas, reportando automáticamente en la respuesta los errores que se produzcan. En este caso necesitaba realizar una validación de que los datos de entrada fueran un array de URLs.</li><li><strong><a href="https://github.com/Automattic/kue">Kue</a></strong>: Kue es sistema de <strong>cola de trabajos</strong> que utiliza Redis (una base de datos no-sql en memoria) para almacenar las tareas y que sean distribuidas a diferentes workers. Gracias a Kue logramos la escalabilidad. Permite encolar un trabajo (en este caso un <em>scrapeo</em> de una URL) y que sea atendido por un <em>worker</em>.</li></ul><p>El código del servidor quedó en lo siguiente:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> Hapi   = <span class="built_in">require</span>(<span class="string">'hapi'</span>);</div><div class="line"><span class="keyword">const</span> kue    = <span class="built_in">require</span>(<span class="string">'kue'</span>);</div><div class="line"><span class="keyword">const</span> Joi    = <span class="built_in">require</span>(<span class="string">'joi'</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> Hapi.Server();</div><div class="line"><span class="keyword">const</span> queue  = kue.createQueue();</div><div class="line"></div><div class="line">server.connection(&#123;</div><div class="line">  <span class="attr">host</span>: <span class="string">'localhost'</span>,</div><div class="line">  <span class="attr">port</span>: <span class="number">8000</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">server.route(&#123;</div><div class="line">  <span class="attr">method</span>: <span class="string">'POST'</span>,</div><div class="line">  <span class="attr">path</span>:<span class="string">'/urls'</span>,</div><div class="line">  <span class="attr">handler</span>: postUrls,</div><div class="line">  <span class="attr">config</span>: &#123;</div><div class="line">    <span class="attr">validate</span>: &#123;</div><div class="line">      <span class="attr">payload</span>: &#123;</div><div class="line">        <span class="attr">urls</span>: Joi.array().required().items(Joi.string().uri(&#123;<span class="attr">scheme</span>: [<span class="string">'http'</span>, <span class="string">'https'</span>]&#125;))</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">server.start();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">postUrls</span>(<span class="params">request, reply</span>) </span>&#123;</div><div class="line">  request.payload.urls.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">url</span>) </span>&#123;</div><div class="line">    queue.create(<span class="string">'scrape'</span>, &#123;</div><div class="line">      <span class="attr">url</span>: url</div><div class="line">    &#125;).save();</div><div class="line">  &#125;);</div><div class="line">  reply().code(<span class="number">202</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Este código hace lo siguiente:</p><ul><li>Define el servidor Hapi, indicando una ruta /urls, con método POST, una validación y una función manejadora.</li><li>La función manejadora recibe la lista de URLs, y por cada una crea una tarea mediante Kue.</li></ul><p>Simple y efectivo. <strong>Total de líneas de código del servidor: 37</strong>.</p><h2 id="Workers"><a href="#Workers" class="headerlink" title="Workers"></a>Workers</h2><p>Los workers debían de recibir las tareas, realizar el <em>scrapeo</em> y guardar la información en el MongoDB. Para ello utilicé:</p><ul><li>Kue: la cola de tareas que vimos antes.</li><li><strong><a href="https://www.npmjs.com/package/ineed" target="_blank" rel="external">Ineed</a></strong>: un módulo para realizar <strong>scraping sencillísimo de utilizar</strong>. Ideal para zoquetes como un servidor.</li><li><strong><a href="https://www.npmjs.com/package/mongodb" target="_blank" rel="external">mongodb</a></strong>: el <strong>driver de MongoDB para Node.js</strong>.</li></ul><p>El código quedó tal que así:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> kue         = <span class="built_in">require</span>(<span class="string">'kue'</span>);</div><div class="line"><span class="keyword">const</span> ineed       = <span class="built_in">require</span>(<span class="string">'ineed'</span>);</div><div class="line"><span class="keyword">const</span> MongoClient = <span class="built_in">require</span>(<span class="string">'mongodb'</span>).MongoClient;</div><div class="line"></div><div class="line"><span class="keyword">const</span> queue = kue.createQueue();</div><div class="line"></div><div class="line"><span class="keyword">let</span> db;</div><div class="line"><span class="keyword">let</span> collection;</div><div class="line"></div><div class="line">MongoClient.connect(<span class="string">'mongodb://localhost:27017/scraper'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, database</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (err) &#123;</div><div class="line">    <span class="built_in">console</span>.log(err);</div><div class="line">    process.exit(<span class="number">1</span>);</div><div class="line">  &#125;</div><div class="line">  db = database;</div><div class="line">  collection = db.collection(<span class="string">'webdata'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">queue.process(<span class="string">'scrape'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">job, done</span>)</span>&#123;</div><div class="line">  scrape(job.data.url);</div><div class="line">  done();</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">scrape</span>(<span class="params">url</span>) </span>&#123;</div><div class="line">  ineed.collect.texts.from(&#123;</div><div class="line">    <span class="attr">headers</span>: &#123;</div><div class="line">      <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.1; rv:31.0) Gecko/20100101 Firefox/31.0'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">url</span>: url</div><div class="line">  &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, response, result</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (err) &#123;</div><div class="line">        <span class="built_in">console</span>.log(err);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        collection.insert(result, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">          <span class="keyword">if</span> (err) &#123;</div><div class="line">            <span class="built_in">console</span>.log(err);</div><div class="line">          &#125;</div><div class="line">        &#125;);</div><div class="line">      &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>Explicación:</p><ul><li>En primer lugar conectamos a MongoDB y asignamos a la tarea <em>scrape</em> su función manejadora.</li><li>En la función scrape, utilizamos Ineed para recolectar el texto de la URL y posteriormente lo guardamos en una colección de MongoDB.</li></ul><p><strong>Total de líneas de código del worker: 43</strong>.</p><p><strong>NOTA</strong>: en la versión de producción tengo las direcciones del MongoDB y el Redis en un fichero de configuración. Pero en esta primera prueba lo hice todo en una sola máquina y por ello están hardcodeadas.</p><hr><p>###</p><p>Como has visto, apoyándonos en módulos existentes y con muy poco código se pueden hacer cosas muy interesantes.</p><p><strong>No es mi intención con este post animarte a escribir programas en menos de 100 líneas</strong> (entre otras cosas, aquí no he puesto los ficheros de configuración ni los tests, ni he desanidado los callbacks).</p><p><strong>Sí lo es poner de manifiesto que el ecosistema de NPM es muy rico</strong>, y que, <strong>juntando módulos a modo de piezas de <em>Lego</em>, se pueden hacer grandes cosas</strong>, así como enseñarte algunos módulos que creo que son interesantes.</p><p>Bien es verdad que el hecho de que haya muchos módulos no quiere decir que todos sean buenos. Pero hay más donde elegir.</p><p>Además es muy sencillo crear tus propios módulos si ves que no hay ninguno que cubra tus necesidades. Pero esto lo dejo para otro post.</p><p><br></p><p>Imagen: <a href="https://www.flickr.com/photos/dahlstroms/4440771174/" target="_blank" rel="external">Håkan Dahlström</a> / <a href="http://foter.com/" target="_blank" rel="external">Foter</a> / <a href="http://creativecommons.org/licenses/by/2.0/" target="_blank" rel="external">CC BY</a></p></div></article></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives">Writing</a></li><li><a href="/projects">Projects</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Diseno"><span class="toc-number">1.</span> <span class="toc-text">Diseño</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Servidor"><span class="toc-number">2.</span> <span class="toc-text">Servidor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Workers"><span class="toc-number">3.</span> <span class="toc-text">Workers</span></a></li></ol></div><div id="actions-footer"><ul><li id="toc"><a class="icon" href="#actions-footer"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li><li id="top" style="display:none"><a class="icon" href="#"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li><li id="menu"><a class="icon" href="#actions-footer"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li></ul></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2018 Emilio J. Grande</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives">Writing</a></li><li><a href="/projects">Projects</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li></ul></nav></div></footer><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/lib/meslo-LG/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/js/main.js"></script></body></html>