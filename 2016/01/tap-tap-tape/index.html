<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Como ya sabes el testing es algo necesario y conveniente en el desarrollo de software. En mi opinión especialmente crítico en proyectos grandes, o dentro de un equipo de personas, para asegurar que cu"><meta name="keywords" content="nodejs,testing"><meta property="og:type" content="article"><meta property="og:title" content="Tap Tap Go! - Test Anything Protocol en Node.js: Cómo usar el módulo tape y calcular la cobertura"><meta property="og:url" content="https://github.com/er1x/2016/01/tap-tap-tape/index.html"><meta property="og:site_name" content="Emilio J. Grande | Web Developer"><meta property="og:description" content="Como ya sabes el testing es algo necesario y conveniente en el desarrollo de software. En mi opinión especialmente crítico en proyectos grandes, o dentro de un equipo de personas, para asegurar que cu"><meta property="og:locale" content="default"><meta property="og:image" content="https://github.com/images/2016-01/tape-testing.jpg"><meta property="og:image" content="https://github.com/images/2016-01/tape-run.png"><meta property="og:image" content="https://github.com/images/2016-01/istanbul-run.png"><meta property="og:image" content="https://github.com/images/2016-01/html-coverage.png"><meta property="og:image" content="https://github.com/images/2016-01/istanbul-run-2.png"><meta property="og:updated_time" content="2017-03-11T12:54:27.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Tap Tap Go! - Test Anything Protocol en Node.js: Cómo usar el módulo tape y calcular la cobertura"><meta name="twitter:description" content="Como ya sabes el testing es algo necesario y conveniente en el desarrollo de software. En mi opinión especialmente crítico en proyectos grandes, o dentro de un equipo de personas, para asegurar que cu"><meta name="twitter:image" content="https://github.com/images/2016-01/tape-testing.jpg"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>Tap Tap Go! - Test Anything Protocol en Node.js: Cómo usar el módulo tape y calcular la cobertura</title></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" style="display:none"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives">Writing</a></li><li><a href="/projects">Projects</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li></ul></span><br><div id="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-Anything-Protocol"><span class="toc-number">1.</span> <span class="toc-text">Test Anything Protocol</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ejemplo-SUT-Dragon-Balls"><span class="toc-number">2.</span> <span class="toc-text">Ejemplo. SUT: Dragon Balls</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sut-js"><span class="toc-number">2.1.</span> <span class="toc-text">sut.js</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Uso-de-Tape"><span class="toc-number">3.</span> <span class="toc-text">Uso de Tape</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sut-test-js"><span class="toc-number">3.1.</span> <span class="toc-text">sut-test.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ejecutar-los-tests"><span class="toc-number">3.2.</span> <span class="toc-text">Ejecutar los tests</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Calculando-la-cobertura-con-Istanbul"><span class="toc-number">4.</span> <span class="toc-text">Calculando la cobertura con Istanbul</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#¡Ramas-ramas"><span class="toc-number">4.1.</span> <span class="toc-text">¡Ramas, ramas!</span></a></li></ol></li></ol></div></span></div><div class="content index width mx-auto px2 my4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Tap Tap Go! - Test Anything Protocol en Node.js: Cómo usar el módulo tape y calcular la cobertura</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Emilio J. Grande | Web Developer</span></span><div class="postdate">&nbsp;<time datetime="2016-01-11T07:00:00.000Z" itemprop="datePublished">11-01-2016</time></div><div class="article-tag"><i class="fa fa-tag"></i> <a class="tag-link" href="/tags/nodejs/">nodejs</a>, <a class="tag-link" href="/tags/testing/">testing</a></div></div></header><div class="content" itemprop="articleBody"><p><img src="/images/2016-01/tape-testing.jpg" alt="TAP - Tape!"></p><p>Como ya sabes el testing es algo necesario y conveniente en el desarrollo de software. En mi opinión especialmente crítico en proyectos grandes, o dentro de un equipo de personas, para asegurar que cuando uno se pone a <em>picar</em> algo, no se rompe nada.</p><h2 id="Test-Anything-Protocol"><a href="#Test-Anything-Protocol" class="headerlink" title="Test Anything Protocol"></a>Test Anything Protocol</h2><p><strong><a href="https://testanything.org/" target="_blank" rel="external">Test anything protocol (TAP)</a></strong> es un estándar de testing que define un formato de salida de este tipo de herramientas, por lo que facilita su integración con otros sisstemas (herramientas de cálculo de cobertura, integración continua etc…)</p><h2 id="Ejemplo-SUT-Dragon-Balls"><a href="#Ejemplo-SUT-Dragon-Balls" class="headerlink" title="Ejemplo. SUT: Dragon Balls"></a>Ejemplo. SUT: Dragon Balls</h2><p>Vamos a establecer nuestro SUT (Subject under test), es decir el código que vamos a probar.</p><p>En este caso se me ha ocurrido un ejemplo un poco absurdo. Una clase que puede usarse para invocar a diversos dragones de la archiconocida serie <em><a href="https://es.wikipedia.org/wiki/Dragon_Ball" target="_blank" rel="external">Dragon Ball</a></em>.</p><p>En fin, el caso es que <strong>lo que vamos a probar es una clase (<a href="https://babeljs.io/docs/learn-es2015/" target="_blank" rel="external">ES2015</a>), con un método <em>summonDragon</em></strong>, que dependiendo del número de dragon balls y el tipo de estas bolas, nos devolverá un dragón u otro.</p><h3 id="sut-js"><a href="#sut-js" class="headerlink" title="sut.js"></a>sut.js</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DragonSummoner</span> </span>&#123;</div><div class="line">  summonDragon (ballsNumber, ballsType) &#123;</div><div class="line">    <span class="keyword">if</span> (ballsNumber &lt; <span class="number">7</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">`Wrong ballsNumber!:  <span class="subst">$&#123;ballsNumber&#125;</span>`</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (ballsType !== <span class="string">'namek'</span> &amp;&amp; ballsType !== <span class="string">'earth'</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">`Wrong ballsType!:  <span class="subst">$&#123;ballsType&#125;</span>`</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ballsNumber === <span class="number">7</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (ballsType === <span class="string">'namek'</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'Polunga'</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (ballsType === <span class="string">'earth'</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'Shenron'</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = DragonSummoner</div></pre></td></tr></table></figure><h2 id="Uso-de-Tape"><a href="#Uso-de-Tape" class="headerlink" title="Uso de Tape"></a>Uso de Tape</h2><p>Para probar esta clase <strong>vamos a usar <a href="https://github.com/substack/tape">Tape</a></strong>. Tape es una biblioteca de testing que implementa el protocolo TAP. Además vamos a agregarle un output diferente de salida, más visual, que podremos entender mejor. Lo meteremos todo en un script de NPM</p><p>Instalamos tape y el spec:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install tape tap-spec --save-dev</div></pre></td></tr></table></figure><p>Y ahora escribimos nuestro test:</p><h3 id="sut-test-js"><a href="#sut-test-js" class="headerlink" title="sut-test.js"></a>sut-test.js</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> test = <span class="built_in">require</span>(<span class="string">'tape'</span>)</div><div class="line"><span class="keyword">const</span> DragonSummoner = <span class="built_in">require</span>(<span class="string">'./sut'</span>)</div><div class="line"></div><div class="line">test(<span class="string">'DragonSummoner'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">t</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> dragonSummoner = <span class="keyword">new</span> DragonSummoner()</div><div class="line"></div><div class="line">  t.ok(DragonSummoner, <span class="string">'should be defined'</span>)</div><div class="line"></div><div class="line">  t.equal(<span class="keyword">typeof</span> DragonSummoner, <span class="string">'function'</span>, <span class="string">'should be a function'</span>)</div><div class="line"></div><div class="line">  t.ok(dragonSummoner.summonDragon, <span class="string">'has a summonDragon method'</span>)</div><div class="line"></div><div class="line">  t.equal(<span class="string">'Polunga'</span>, dragonSummoner.summonDragon(<span class="number">7</span>, <span class="string">'namek'</span>), <span class="string">'should summon Polunga if 7 namekian balls are used'</span>)</div><div class="line">  t.equal(<span class="string">'Shenron'</span>, dragonSummoner.summonDragon(<span class="number">7</span>, <span class="string">'earth'</span>), <span class="string">'should summon Shenron if 7 earth balls are used'</span>)</div><div class="line"></div><div class="line">  t.end()</div><div class="line">&#125;)</div></pre></td></tr></table></figure><p>Como ves, el testeo es relativamente sencillo.</p><p>Se <strong>define el sujeto que se va a testear y las diferentes <em>aserciones</em></strong>, en este sentido es muy similar a otros frameworks de test como <a href="https://mochajs.org/" target="_blank" rel="external">Mocha</a>, del que <a href="/2015/06/testing-nodejs/">ya hemos hablado anteriormente</a>.</p><p>Puedes ver el resto de métodos de aserción que proporciona Tape <a href="https://github.com/substack/tape#methods">aquí</a>.</p><h3 id="Ejecutar-los-tests"><a href="#Ejecutar-los-tests" class="headerlink" title="Ejecutar los tests"></a>Ejecutar los tests</h3><p>Para ejecutar tests yo suelo utilizar una tarea NPM, y en casos más complejos utilizo un <em>task runner</em> como <a href="http://blog.koalite.com/2015/06/grunt-o-gulp-que-uso/" target="_blank" rel="external">Grunt o Gulp</a>.</p><p>Para este ejemplo he definido esta tarea en el <em>package.json</em>:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"tape-testing"</span>,</div><div class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">  <span class="attr">"description"</span>: <span class="string">""</span>,</div><div class="line">  <span class="attr">"main"</span>: <span class="string">"sut.js"</span>,</div><div class="line">  <span class="attr">"scripts"</span>: &#123;</div><div class="line">    <span class="attr">"test"</span>: <span class="string">"tape *-test.js |tap-spec"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</div><div class="line">  <span class="attr">"license"</span>: <span class="string">"MIT"</span>,</div><div class="line">  <span class="attr">"devDependencies"</span>: &#123;</div><div class="line">    <span class="attr">"istanbul"</span>: <span class="string">"^0.4.1"</span>,</div><div class="line">    <span class="attr">"tap-spec"</span>: <span class="string">"^4.1.1"</span>,</div><div class="line">    <span class="attr">"tape"</span>: <span class="string">"^4.2.2"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p><img src="/images/2016-01/tape-run.png" alt="Tape run"></p><h2 id="Calculando-la-cobertura-con-Istanbul"><a href="#Calculando-la-cobertura-con-Istanbul" class="headerlink" title="Calculando la cobertura con Istanbul"></a>Calculando la cobertura con Istanbul</h2><p>Guay. Ahora vamos a utilizar la herramienta <strong><a href="https://github.com/gotwarlost/istanbul">Istanbul</a></strong> para <strong>calcular la cobertura de nuestros tests JavaScript</strong>. Esto es, la cantidad de código que tenemos cubierto por nuestras pruebas. En general, cuanta mayor cobertura, mejor.</p><p>Instalamos istanbul<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install istanbul --save-dev</div></pre></td></tr></table></figure><p></p><p>Y definimos una nueva tarea en el package.json para ejecutarlo contra los tests:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="string">"scripts"</span>: &#123;</div><div class="line">  <span class="string">"test"</span>: <span class="string">"tape *-test.js |tap-spec"</span>,</div><div class="line">  <span class="string">"cover"</span>: <span class="string">"istanbul cover *-test.js"</span></div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure><p>Probamos a ejecutarlo…</p><p><img src="/images/2016-01/istanbul-run.png" alt="Istanbul run"></p><p>Istanbul nos deja una carpeta con un <strong>informe HTML</strong> más visual en el que podemos examinar la cobertura y ver qué nos falta por cubrir.</p><p><img src="/images/2016-01/html-coverage.png" alt="Cobertura"></p><h3 id="¡Ramas-ramas"><a href="#¡Ramas-ramas" class="headerlink" title="¡Ramas, ramas!"></a>¡Ramas, ramas!</h3><p>Como ves, no hemos probado los casos de error. Vamos a probarlos:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">t.throws(<span class="function"><span class="params">()</span> =&gt;</span> dragonSummoner.summonDragon(<span class="number">5</span>, <span class="string">'earth'</span>), <span class="string">'should throw an error if less than 7 balls are provided'</span>)</div><div class="line">t.throws(<span class="function"><span class="params">()</span> =&gt;</span> dragonSummoner.summonDragon(<span class="number">7</span>, <span class="string">'unknown'</span>), <span class="string">'should throw an error if wrong balls are used'</span>)</div><div class="line">...</div></pre></td></tr></table></figure><p>Con esto volvemos a ejecutar Istanbul y…</p><p><img src="/images/2016-01/istanbul-run-2.png" alt="Cobertura 2"></p><hr><p>En este post has visto lo sencillo que es <strong>utilizar el framework de test Tape y calcular la cobertura con Istanbul en un proyecto JavaScript</strong>.</p><p>Además, definiendo tareas npm sencillas.</p><p>¿Qué opinas de tape?</p><p>¿Prefieres mocha u otro framework de testing?</p><p>¿Usas Istabul para el cáclulo de cobertura?</p></div></article></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives">Writing</a></li><li><a href="/projects">Projects</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-Anything-Protocol"><span class="toc-number">1.</span> <span class="toc-text">Test Anything Protocol</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ejemplo-SUT-Dragon-Balls"><span class="toc-number">2.</span> <span class="toc-text">Ejemplo. SUT: Dragon Balls</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sut-js"><span class="toc-number">2.1.</span> <span class="toc-text">sut.js</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Uso-de-Tape"><span class="toc-number">3.</span> <span class="toc-text">Uso de Tape</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sut-test-js"><span class="toc-number">3.1.</span> <span class="toc-text">sut-test.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ejecutar-los-tests"><span class="toc-number">3.2.</span> <span class="toc-text">Ejecutar los tests</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Calculando-la-cobertura-con-Istanbul"><span class="toc-number">4.</span> <span class="toc-text">Calculando la cobertura con Istanbul</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#¡Ramas-ramas"><span class="toc-number">4.1.</span> <span class="toc-text">¡Ramas, ramas!</span></a></li></ol></li></ol></div><div id="actions-footer"><ul><li id="toc"><a class="icon" href="#actions-footer"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li><li id="top" style="display:none"><a class="icon" href="#"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li><li id="menu"><a class="icon" href="#actions-footer"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li></ul></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2018 Emilio J. Grande</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives">Writing</a></li><li><a href="/projects">Projects</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li></ul></nav></div></footer><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/lib/meslo-LG/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/js/main.js"></script></body></html>