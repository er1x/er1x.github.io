<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Las primeras veces que me puse con el tema del testing en Node.js me volvía un poco loco. En internet no haces más que ver nombres de herramientas en plan: Qunit, Mocha, Jasmine, Tape, Chai, Assert, K"><meta property="og:type" content="article"><meta property="og:title" content="Aprende a hacer Testing en Node.js: Mocha, Chai, Sinon, Proxyquire... WTF"><meta property="og:url" content="https://github.com/er1x/2015/06/testing-nodejs/index.html"><meta property="og:site_name" content="Emilio J. Grande | Web Developer"><meta property="og:description" content="Las primeras veces que me puse con el tema del testing en Node.js me volvía un poco loco. En internet no haces más que ver nombres de herramientas en plan: Qunit, Mocha, Jasmine, Tape, Chai, Assert, K"><meta property="og:image" content="https://github.com/er1x/images/2015-06/testing--1-.png"><meta property="og:image" content="https://github.com/er1x/images/2015-06/i-have-no-idea-what-im-doing-dog.jpg"><meta property="og:image" content="https://github.com/er1x/images/2015-06/notification.png"><meta property="og:image" content="https://github.com/er1x/images/2015-06/ejecucion.png"><meta property="og:updated_time" content="2017-03-11T12:54:27.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Aprende a hacer Testing en Node.js: Mocha, Chai, Sinon, Proxyquire... WTF"><meta name="twitter:description" content="Las primeras veces que me puse con el tema del testing en Node.js me volvía un poco loco. En internet no haces más que ver nombres de herramientas en plan: Qunit, Mocha, Jasmine, Tape, Chai, Assert, K"><meta name="twitter:image" content="https://github.com/er1x/images/2015-06/testing--1-.png"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><title>Aprende a hacer Testing en Node.js: Mocha, Chai, Sinon, Proxyquire... WTF</title><style type="text/css">.content h1,.fa,body{-moz-osx-font-smoothing:grayscale}#footer-post a,#header-post a,.content a{text-decoration:none}.fa{display:inline-block;font:normal normal normal 14px/1 FontAwesome;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased}#header-post #nav,.content h1{font-style:normal;letter-spacing:.01em}body,pre{font-family:Menlo,"Meslo LG",monospace}.fa-lg{font-size:1.33333333em;line-height:.75em;vertical-align:-15%}.fa-tag:before{content:"\f02b"}.fa-list:before{content:"\f03a"}.fa-chevron-up:before{content:"\f077"}.fa-bars:before{content:"\f0c9"}#header-post #toc .toc-level-2:before,.article-tag .tag-link:before{content:"#"}*,:after,:before{box-sizing:border-box}.content h1,body{-webkit-font-smoothing:antialiased}.my4{margin-top:4rem;margin-bottom:4rem}.mx-auto{margin-left:auto;margin-right:auto}.px2{padding-left:1rem;padding-right:1rem}.content h1{font-size:1.5em;font-weight:700;color:#2bbc8a;margin-top:3rem;margin-bottom:1rem;display:block}#header-post #nav ul li{border-right:1px dotted #2bbc8a}body{text-rendering:geometricPrecision;line-height:1.725;color:#c9cacc;background-color:#1d1f21;font-size:14px;font-weight:400;min-height:100%;display:flex;flex-direction:column}.content td{border-bottom:none;padding:9px 8px 0}html{height:100%;border-top:2px solid #c9cacc}.content{flex:1}.content p{-moz-hyphens:auto;-ms-hyphens:auto;-webkit-hyphens:auto;hyphens:auto}.content pre{-moz-hyphens:manual;-ms-hyphens:manual;-webkit-hyphens:manual;hyphens:manual}.content a{color:#c9cacc;background-repeat:repeat-x;background-position:bottom;background-size:100% 6px;background-image:linear-gradient(transparent,transparent 5px,#c9cacc 5px,#c9cacc)}#header-post #nav ul li:last-child a,#header-post ul li:last-child{margin-right:0}.width{width:100%;max-width:39rem}@media (max-width:480px){.my4{margin-top:2rem;margin-bottom:2rem}}#header-post #nav ul{line-height:15px}#header-post #nav{font-weight:200;font-size:.8rem;color:#2bbc8a}#header-post a{color:inherit;background:0 0}#header-post{position:fixed;top:2rem;right:2rem;display:inline-block;float:right}#header-post ol{list-style-type:none}#header-post ul{list-style-type:none;margin:0;padding:0;display:inline-block}#header-post ul li{margin-right:15px;display:inline-block;vertical-align:middle}#header-post #menu-icon,#header-post #menu-icon-tablet{float:right;margin-left:15px}#header-post #top-icon-tablet{margin-left:15px;bottom:2rem;right:2rem;position:fixed}#header-post #menu{visibility:hidden}#header-post #nav ul a{margin-right:15px;color:color-accent}#header-post #nav ul li:last-child{border-right:0;margin-right:0}#header-post #toc{clear:both;text-align:right;padding-top:1rem}#header-post #toc .toc-number{display:none}#header-post #toc .toc-level-2{font-size:.8rem;color:#c9cacc}#header-post #toc .toc-level-2:before{color:#2bbc8a}#header-post #toc .toc-level-3{font-size:.7rem;color:#b3b3b3}@media screen and (max-width:500px){#header-post{display:none}}@media screen and (max-width:900px){#header-post #menu-icon{display:none}}@media screen and (max-width:1199px){#header-post #toc{display:none}}@media screen and (min-width:900px){#header-post #menu-icon-tablet,#header-post #top-icon-tablet{display:none!important}}#footer-post{bottom:0;left:0;right:0;position:fixed;width:100%;z-index:5000000;background:#212326;border-top:1px solid #666673}#footer-post a,#footer-post a.icon,.highlight pre{background:0 0}#footer-post a{color:inherit}#footer-post #nav-footer{margin-left:1rem;margin-right:1rem;text-align:center}#footer-post #nav-footer a{color:#2bbc8a;font-size:1rem}#footer-post #actions-footer ul,#footer-post #nav-footer ul{list-style-type:none;margin:0;padding:0;display:table;width:100%}#footer-post #nav-footer ul li{display:inline-table;width:20%;padding:10px;vertical-align:middle}#footer-post #actions-footer{text-align:center;margin-top:1rem;margin-bottom:1rem;width:100%}#footer-post #actions-footer a{color:#2bbc8a}#footer-post #actions-footer ul li{display:table-cell;vertical-align:middle}#footer-post #toc-footer .toc-number{display:none}#footer-post #toc-footer{clear:both;text-align:left;padding-top:1rem}#footer-post #toc-footer ol{list-style-type:none;padding-left:20px}#footer-post #toc-footer ol li{line-height:30px}#footer-post #toc-footer .toc-level-2{font-size:.8rem;color:#c9cacc}#footer-post #toc-footer .toc-level-2:before{content:"#";color:#2bbc8a}#footer-post #toc-footer .toc-level-3{font-size:.7rem;color:#666;line-height:15px}@media screen and (min-width:500px){#footer-post-container{display:none}}article header .posttitle{margin-top:0;margin-bottom:0;text-transform:none;font-size:1.5em;line-height:1.25}article header .meta{margin-top:0;margin-bottom:1rem}article header .meta *{color:#ccc;font-size:.85rem}article header .author{text-transform:uppercase;letter-spacing:.01em;font-weight:700}article header .postdate{display:inline}article .content img{max-width:100%;height:auto;display:block;margin:auto}.posttitle{text-transform:none;font-size:1.5em;line-height:1.25}@media (min-width:480px){p{text-align:justify}.article-tag{display:inline}.article-tag:before{content:"|"}}pre{overflow-x:auto;font-size:13px;padding:10px 15px 0;line-height:22px;-webkit-border-radius:4px;border-radius:4px;border:1px dotted #666}.highlight pre{padding:0;border:none}.highlight td.gutter{text-align:right;padding-right:20px;display:none}</style></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" style="display:none"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archives">Writing</a></li><li><a href="/projects">Projects</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li></ul></span><br><div id="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Algo-que-Probar"><span class="toc-number">1.</span> <span class="toc-text">Algo que Probar</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#¡A-Probar"><span class="toc-number">2.</span> <span class="toc-text">¡A Probar!</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Usando-mocha"><span class="toc-number">2.1.</span> <span class="toc-text">Usando mocha</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bibliotecas-de-Asserts-Chai"><span class="toc-number">3.</span> <span class="toc-text">Bibliotecas de Asserts: Chai</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mocks-SinonJS"><span class="toc-number">4.</span> <span class="toc-text">Mocks: SinonJS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proxyquire"><span class="toc-number">5.</span> <span class="toc-text">Proxyquire</span></a></li></ol></div></span></div><div class="content index width mx-auto px2 my4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Aprende a hacer Testing en Node.js: Mocha, Chai, Sinon, Proxyquire... WTF</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Emilio J. Grande | Web Developer</span></span><div class="postdate"><time datetime="2015-06-04T05:30:00.000Z" itemprop="datePublished">04-06-2015</time></div><div class="article-tag"><i class="fa fa-tag"></i> <a class="tag-link" href="/tags/nodejs/">nodejs</a>, <a class="tag-link" href="/tags/testing/">testing</a></div></div></header><div class="content" itemprop="articleBody"><p><img src="/images/2015-06/testing--1-.png" alt="unit testing"><br>Las primeras veces que me puse con el tema del testing en Node.js me volvía un poco loco. En internet no haces más que ver nombres de herramientas en plan: Qunit, Mocha, Jasmine, Tape, Chai, Assert, Karma, Proxyquire, Sinon, Mockery… que cambian cada dos días… y es como…</p><p><img src="/images/2015-06/i-have-no-idea-what-im-doing-dog.jpg" alt="no-idea"></p><p>Con el tiempo aprendes cómo va la cosa, pero las primeras veces es un lío. Aquí te va un tutorial para aclarar ideas. Y, como siempre, <a href="https://github.com/er1x/testing101">el repo aquí</a>.</p><h2 id="Algo-que-Probar"><a href="#Algo-que-Probar" class="headerlink" title="Algo que Probar"></a>Algo que Probar</h2><p>Si queremos hacer testing, primero tenemos que tener algo para probar. En este caso vamos a hacer un módulo muy sencillito, que exporte una función que sume 2 a la entrada:</p><p><strong>my-module.js</strong><br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTwo</span>(<span class="params">num</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'processing input...'</span>);</div><div class="line">  <span class="keyword">return</span> num + <span class="number">2</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = addTwo;</div></pre></td></tr></table></figure><p></p><h2 id="¡A-Probar"><a href="#¡A-Probar" class="headerlink" title="¡A Probar!"></a>¡A Probar!</h2><p>Para probar este código necesitamos una biblioteca de testing. Aquí tenemos varias opciones, y las más conocidas son:</p><ul><li><a href="https://qunitjs.com/" target="_blank" rel="external">Qunit</a></li><li><a href="https://github.com/substack/tape">Tape</a></li><li><a href="http://jasmine.github.io/" target="_blank" rel="external">Jasmine</a></li><li><a href="http://mochajs.org/" target="_blank" rel="external">Mocha</a></li></ul><p>¿Cuál escoger? Pues ahí va a gustos… Yo en estos casos suelo ir a lo que use más gente, para evitar problemas, así que <strong>escojo Mocha</strong>.<br>Lo cierto es que la forma de hacer pruebas es bastante similar entre ellas, de modo que no tendrás problemas para coger código de una diferente una vez hayas aprendido cómo va el tema.</p><h3 id="Usando-mocha"><a href="#Usando-mocha" class="headerlink" title="Usando mocha"></a>Usando mocha</h3><p>Para usar mocha podemos instalarlo bien como utilidad global (<em>npm install -g</em>) o local al proyecto (sin el -g). En este caso como el objetivo es aprender a usar Mocha lo instalaremos globalmente.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g mocha</div></pre></td></tr></table></figure><p>Perfecto. Ahora deberías tener el comando <em>mocha</em> funcionando. No te preocupes si te tira un error. Por defecto busca el directorio <em>test</em> y si no lo encuentra se queja.</p><p>Ahora vamos a <strong>escribir un test para Mocha en un fichero test.js</strong>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> myModule = <span class="built_in">require</span>(<span class="string">'./my-module'</span>);</div><div class="line"><span class="keyword">var</span> assert   = <span class="built_in">require</span>(<span class="string">'assert'</span>);</div><div class="line"></div><div class="line">describe(<span class="string">'My Module'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  it(<span class="string">'should add 2 to a number'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">    assert.equal(<span class="number">5</span>, myModule(<span class="number">3</span>));</div><div class="line"></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>¿Qué estamos haciendo aquí?</p><ul><li>Primero importamos el módulo que vamos a testear, junto con una utilidad assert, que viene en el core de Node.js.</li><li>Después comenzamos con un <em>describe</em> que indica el módulo que vamos a testear.</li><li>Seguidamente y dentro del <em>describe</em>, vamos añadiendo cada test como un <em>it…</em></li><li>Dentro del test propiamente dicho, comprobamos que nuestro módulo suma 2 correctamente.</li></ul><p>De esta manera, nuestros tests quedan bastante expresivos, pues componen frases cómo: <em>“Mí módulo debería hacer tal cosa…”</em></p><p>Basta de escribir. Vamos a ejecutar el test:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mocha test.js</div><div class="line"></div><div class="line">processing input...</div><div class="line">    ✓ should add 2 to a number</div><div class="line"></div><div class="line">  1 passing (8ms)</div></pre></td></tr></table></figure><p>El test pasa. Perfecto. Pero Mocha admite muchas cosas más.</p><p>Con <strong>mocha -h</strong> puedes ver un montón de opciones que te permite definir. Además, si las escribes en un fichero <strong>mocha.opts</strong>, no tendrás que especificarlas cada vez.</p><p>De momento vamos a poner un fichero mocha.opts, con el siguiente contenido:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">--growl</div><div class="line">--reporter dot</div></pre></td></tr></table></figure><p>Ahora podemos ejecutar los test con:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mocha test.js --opts mocha.opts</div></pre></td></tr></table></figure><p>Y nos reportará de forma mucho más concisa y mostrará una notificación.</p><p><img src="/images/2015-06/notification.png" alt="notificacion"></p><p>Para mí, las opciones más interesantes son éstas:</p><ul><li>–watch : para quedarse a la espera de cambios en el código y ejecutarse cada vez.</li><li>–debug-brk: para pararse en el primer punto y poder hacer debug.</li><li>–timeout: para ponerle un timeout a los test. Útil para probar cosas asíncronas.</li></ul><p>Muy bien , ya sabemos cómo pasarle opciones a Mocha.</p><h2 id="Bibliotecas-de-Asserts-Chai"><a href="#Bibliotecas-de-Asserts-Chai" class="headerlink" title="Bibliotecas de Asserts: Chai"></a>Bibliotecas de Asserts: Chai</h2><p>La utilidad <em>assert</em> que viene con Node.js tiene una capacidad limitada, y por eso se suelen utilizar bibliotecas específicas para asserts, que permiten una sintaxis más rica.</p><p>La que más se utiliza es <strong><a href="http://chaijs.com/" target="_blank" rel="external">Chai</a></strong>, que permite <strong><a href="http://chaijs.com/api/" target="_blank" rel="external">varios tipos de asserts</a></strong>. Puedes instalar Chai de manera local al proyecto con <em>npm install chai</em>.</p><p>Vamos a modificar el test para que utiice una sintaxis de tipo expect:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> myModule = <span class="built_in">require</span>(<span class="string">'./my-module'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> chai   = <span class="built_in">require</span>(<span class="string">'chai'</span>);</div><div class="line"><span class="keyword">var</span> expect = chai.expect;</div><div class="line"></div><div class="line"></div><div class="line">describe(<span class="string">'My Module'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  it(<span class="string">'should add 2 to a number'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">    expect(myModule(<span class="number">3</span>)).to.be.equal(<span class="number">5</span>);</div><div class="line"></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>Simplemente hemos importado Chai y su expect, y lo hemos utilizado en el test.</p><p>¡Muy bien! Ya sabemos utilizar frameworks de testing y bibliotecas de asserts. Pero… ¿y si quieres hacer mocks?</p><h2 id="Mocks-SinonJS"><a href="#Mocks-SinonJS" class="headerlink" title="Mocks: SinonJS"></a>Mocks: SinonJS</h2><p>Como habrás adivinado, <strong><a href="http://sinonjs.org/" target="_blank" rel="external">Sinon</a></strong> es la biblioteca más utilizada para hacer mocks en JS.</p><p>Una vez más la instalamos localmente:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install sinon</div></pre></td></tr></table></figure><p>Sinon nos permite crear varios tipos de objetos:</p><ul><li><strong>Spies</strong>: son funciones que graban todo lo que les pasa. Se suelen utilizar, por ejemplo, para comprobar que una callback o un método ha sido llamado.</li><li><strong>Stubs</strong>: son como spies, pero además con un comportamiento. Puedes programarlos para que tiren excepciones, por ejemplo.</li><li><strong>Mocks</strong>: son stubs con expects programados.</li></ul><p>Pongamos por caso que queremos probar la función anterior, pero que necesita un parámetro extra para realizar un proceso que nosotros no queremos llevar a cabo:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTwo</span>(<span class="params">num, otherParam</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'processing input...'</span>);</div><div class="line">  otherParam.superFunction();</div><div class="line">  <span class="keyword">return</span> num + <span class="number">2</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = addTwo;</div></pre></td></tr></table></figure><p>Para probar esto, bien nos sirve un simple spy.</p><p><strong>test.js</strong><br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> myModule = <span class="built_in">require</span>(<span class="string">'./my-module'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> chai   = <span class="built_in">require</span>(<span class="string">'chai'</span>);</div><div class="line"><span class="keyword">var</span> expect = chai.expect;</div><div class="line"></div><div class="line"><span class="keyword">var</span> sinon    = <span class="built_in">require</span>(<span class="string">'sinon'</span>);</div><div class="line"></div><div class="line"></div><div class="line">describe(<span class="string">'My Module'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  it(<span class="string">'should add 2 to a number'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> dontCare = &#123; <span class="attr">superFunction</span>: sinon.spy() &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> value = myModule(<span class="number">3</span>, dontCare);</div><div class="line"></div><div class="line">    expect(value).to.be.equal(<span class="number">5</span>);</div><div class="line">    expect(dontCare.superFunction.called).to.be.true;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure><p></p><p>Aquí hemos:</p><ul><li>Importado Sinon.</li><li>Creado un objeto con un método que es un <em>spy</em> de Sinon.</li><li>Llamado al módulo a testear.</li><li>Comprobado que se ha llamado a la función <em>superFunction</em>.</li></ul><h2 id="Proxyquire"><a href="#Proxyquire" class="headerlink" title="Proxyquire"></a>Proxyquire</h2><p>¡Última ronda! ¿Qué tendríamos que hacer, si por ejemplo, el módulo que vamos a testear depende de otro que no nos interesa que use?</p><p>Por ejemplo, si nuestro módulo a testear fuera:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> hardcoreModuleOfDeath = <span class="built_in">require</span>(<span class="string">'hardcoreModuleOfDeath'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTwo</span>(<span class="params">num, otherParam</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'processing input...'</span>);</div><div class="line">  otherParam.superFunction();</div><div class="line">  hardcoreModuleOfDeath.destroyWorld();</div><div class="line">  <span class="keyword">return</span> num + <span class="number">2</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = addTwo;</div></pre></td></tr></table></figure><p>¡No queremos que se llame a <em>destroyWorld</em>! ¿Cómo solucionamos esto?: con <strong><a href="https://github.com/thlorenz/proxyquire">proxyquire</a></strong>.</p><p>El test quedaría en este caso así:<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> chai       = <span class="built_in">require</span>(<span class="string">'chai'</span>);</div><div class="line"><span class="keyword">var</span> expect     = chai.expect;</div><div class="line"><span class="keyword">var</span> sinon      = <span class="built_in">require</span>(<span class="string">'sinon'</span>);</div><div class="line"><span class="keyword">var</span> proxyquire = <span class="built_in">require</span>(<span class="string">'proxyquire'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">var</span> harmless = &#123;</div><div class="line">  <span class="attr">destroyWorld</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'no way'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">var</span> myModule = proxyquire(<span class="string">'./my-module'</span>, &#123; <span class="string">'./hardcoreModuleOfDeath'</span>: harmless &#125;);</div><div class="line"></div><div class="line">describe(<span class="string">'My Module'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  it(<span class="string">'should add 2 to a number'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> dontCare = &#123; <span class="attr">superFunction</span>: sinon.spy() &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> value = myModule(<span class="number">3</span>, dontCare);</div><div class="line"></div><div class="line">    expect(value).to.be.equal(<span class="number">5</span>);</div><div class="line">    expect(dontCare.superFunction.called).to.be.true;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure><p></p><p>Aquí hemos importado my-module, pero a través de un “proxy”, que ha sustituido el módulo malvado con algo absolutamente inocente :)</p><p><img src="/images/2015-06/ejecucion.png" alt="ejecucion"></p><hr><p>Con esto damos fin a este post sobre <strong>testing en Node.js</strong>. Te recuerdo una vez más que tienes <a href="https://github.com/er1x/testing101">el ejemplo en Github</a>.</p><p>Pásalo bien :)</p></div></article></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/">Home</a></li><li><a href="/archives">Writing</a></li><li><a href="/projects">Projects</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Algo-que-Probar"><span class="toc-number">1.</span> <span class="toc-text">Algo que Probar</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#¡A-Probar"><span class="toc-number">2.</span> <span class="toc-text">¡A Probar!</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Usando-mocha"><span class="toc-number">2.1.</span> <span class="toc-text">Usando mocha</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bibliotecas-de-Asserts-Chai"><span class="toc-number">3.</span> <span class="toc-text">Bibliotecas de Asserts: Chai</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mocks-SinonJS"><span class="toc-number">4.</span> <span class="toc-text">Mocks: SinonJS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proxyquire"><span class="toc-number">5.</span> <span class="toc-text">Proxyquire</span></a></li></ol></div><div id="actions-footer"><ul><li id="toc"><a class="icon" href="#actions-footer"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li><li id="top" style="display:none"><a class="icon" href="#"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li><li id="menu"><a class="icon" href="#actions-footer"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li></ul></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2017 Emilio J. Grande</div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archives">Writing</a></li><li><a href="/projects">Projects</a></li><li><a href="/about">About</a></li><li><a href="/contact">Contact</a></li></ul></nav></div></footer><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/lib/meslo-LG/styles.css"><link rel="stylesheet" href="/css/style.css"><script src="/js/main.js"></script></body></html>